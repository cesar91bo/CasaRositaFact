@page "/articulos/formArticulo"
@page "/articulos/editar/{ArticuloId:int}"
@using CasaRositaFact.Components.Pages.Categorias
@using Microsoft.AspNetCore.Components.Forms
@using Services
@using Models
@using static CasaRositaFact.Models.Articulo
@inject ArticuloService ArticuloService
@inject CategoriaService CategoriaService
@inject PrecioArticuloService PrecioArticuloService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<h3 class="mb-2 text-info fw-bold border-bottom pb-2">@(ArticuloId == null ? "Nuevo Artículo" : "Editar Artículo")</h3>


<EditForm Model="articulo" OnValidSubmit="SaveArticulo">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <h3 class="mb-3 text-secondary fw-bold border-bottom pb-2">Datos generales</h3>
    <div class="row mb-2">
        <div class="col-md-6">
            <label for="Nombre" class="form-label">Nombre</label>
            <InputText id="Nombre" class="form-control" @bind-Value="articulo.Nombre" />
        </div>

        <div class="col-md-6">
            <label for="CodigoProducto" class="form-label">Código del Artículo</label>
            <InputText id="CodigoProducto" class="form-control" @bind-Value="articulo.CodigoProducto" />
        </div>
    </div>

    <div class="mb-4">
        <label for="Descripcion" class="form-label">Descripción</label>
        <InputTextArea id="Descripcion" class="form-control" rows="3" @bind-Value="articulo.Descripcion" />
    </div>

    <h3 class="mb-3 text-secondary fw-bold border-bottom pb-2">Precios</h3>

    <div class="row mb-2">
        <div class="col-md-6">
            <label for="PrecioCosto" class="form-label">Precio de Costo</label>
            <InputNumber id="PrecioCosto" class="form-control" @bind-Value="precioArticulo.PrecioCosto" />
        </div>

        <div class="col-md-6">
            <label for="PorcentajeGanancia" class="form-label">Porcentaje de Ganancia</label>
            <InputNumber id="PorcentajeGanancia" class="form-control" @bind-Value="precioArticulo.PorcentajeGanancia" />
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <label for="PrecioVenta" class="form-label">Precio de Venta</label>
            <InputNumber id="PrecioVenta" class="form-control" @bind-Value="precioArticulo.PrecioVenta" disabled />
        </div>

        <div class="col-md-6">
            <label for="FechaUltimaActualizacion" class="form-label">Última Actualización</label>
            <InputDate id="FechaUltimaActualizacion" class="form-control" @bind-Value="precioArticulo.FechaUltimaActualizacion" disabled />
        </div>
    </div>

    <h3 class="mb-3 text-secondary fw-bold border-bottom pb-2">Clasificación</h3>

    <div class="row mb-2">
        <div class="col-md-6">
            <label class="form-label">Seleccione Categoría</label>
            <CategoriaSelect @bind-SelectedId="articulo.IdCategoria" />
        </div>

        <div class="col-md-6">
            <label class="form-label">Seleccione Rubro</label>
            <InputSelect @bind-Value="articulo.IdUnidadMedida" class="form-select">
                @foreach (var um in unidadesMedida)
                {
                    <option value="@um.IdUnidadMedida">@um.Nombre</option>
                }
            </InputSelect>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <label class="form-label">Seleccione Proveedor</label>
            <InputSelect @bind-Value="articulo.IdProveedor" class="form-select">
                @foreach (var proveedor in proveedores)
                {
                    <option value="@proveedor.IdProveedor">@proveedor.Nombre</option>
                }
            </InputSelect>
        </div>

        <div class="col-md-6">
            <label class="form-label">Seleccione Unidad de Medida</label>
            <InputSelect @bind-Value="articulo.IdRubro" class="form-select">
                @foreach (var rub in rubros)
                {
                    <option value="@rub.IdRubro">@rub.Nombre</option>
                }
            </InputSelect>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <button type="button" class="btn btn-secondary" @onclick="NavigateToArticulos">Cancelar</button>
</EditForm>

@code {
    [Parameter] public int? ArticuloId { get; set; }
    private Articulo articulo = new Articulo()
        {
            Nombre = ""
        };

    private PrecioArticulo precioArticulo = new PrecioArticulo()
        {
            PrecioCosto = 0,
            PrecioVenta = 0
        };

    private List<Categoria> categorias = new();
    private List<Rubro> rubros = new();
    private List<UnidadMedida> unidadesMedida = new();
    private List<Proveedor> proveedores = new();

    protected override async Task OnInitializedAsync()
    {
        if (ArticuloId.HasValue)
        {
            articulo = await ArticuloService.GetByIdAsync(ArticuloId.Value);
            precioArticulo = await PrecioArticuloService.GetLastPrecioByArticuloIdAsync(articulo.IdArticulo) ??
                new PrecioArticulo() { PrecioCosto = 0, PrecioVenta = 0 };
        }
        else
        {
            precioArticulo.FechaUltimaActualizacion = DateTime.Now;

        }

    }

    private async Task SaveArticulo()
    {
    }

    private void NavigateToArticulos()
    {
        NavigationManager.NavigateTo("/articulos");
    }
}
