@using CasaRositaFact.Models
@using Data.Entities
@using System.Globalization

@if (Detalles != null && Detalles.Any(d => d.TotalArticulo.HasValue))
{
    <h3 class="mb-3 text-secondary fw-bold border-bottom pb-2">Resumen de Totales</h3>

    <div class="compact-invoice-summary">
        <!-- Sección: Subtotales sin descuento -->
        <div class="summary-section">
            <div class="section-title">SUBTOTALES</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">SubTotal IVA 0%:</span>
                    <span class="summary-value">@SubTotalIva0.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">SubTotal IVA 10,5%:</span>
                    <span class="summary-value">@SubTotalIva105.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">SubTotal IVA 21%:</span>
                    <span class="summary-value">@SubTotalIva21.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item highlight">
                    <span class="summary-label">SubTotal:</span>
                    <span class="summary-value">@SubTotal.ToString("C2", esAr)</span>
                </div>
            </div>
        </div>

        <!-- Sección: Descuento -->
        <div class="summary-section">
            <div class="section-title">APLICAR DESCUENTO</div>
            <div class="discount-control">
                <label class="discount-label">Porcentaje de descuento:</label>
                <input type="number"
                       class="discount-input"
                       @bind="DescuentoPorcentaje"
                       @bind:event="oninput"
                       min="0"
                       max="100"
                       step="0.01" />
                <span class="discount-percent">%</span>
            </div>
        </div>

        <!-- Sección: Subtotales con descuento -->
        <div class="summary-section">
            <div class="section-title">SUBTOTALES CON DESCUENTO</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">SubTotal c/dto IVA 0%:</span>
                    <span class="summary-value">@SubTotalIva0ConDescuento.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">SubTotal c/dto IVA 10,5%:</span>
                    <span class="summary-value">@SubTotalIva105ConDescuento.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">SubTotal c/dto IVA 21%:</span>
                    <span class="summary-value">@SubTotalIva21ConDescuento.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item highlight">
                    <span class="summary-label">Subtotal con Dto:</span>
                    <span class="summary-value">@SubtotalConDescuento.ToString("C2", esAr)</span>
                </div>
            </div>
        </div>

        <!-- Sección: Bases imponibles -->
        <div class="summary-section">
            <div class="section-title">BASES IMPONIBLES</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Base Imponible IVA 0%:</span>
                    <span class="summary-value">@BaseImponible0.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Base Imponible IVA 10,5%:</span>
                    <span class="summary-value">@BaseImponible105.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Base Imponible IVA 21%:</span>
                    <span class="summary-value">@BaseImponible21.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item highlight">
                    <span class="summary-label">Base Imponible Total:</span>
                    <span class="summary-value">@BaseImponibleTotal.ToString("C2", esAr)</span>
                </div>
            </div>
        </div>

        <!-- Sección: Totales finales -->
        <div class="summary-section">
            <div class="section-title">TOTALES FINALES</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Total IVA 10,5%:</span>
                    <span class="summary-value">@TotalIva105.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Total IVA 21%:</span>
                    <span class="summary-value">@TotalIva21.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item highlight">
                    <span class="summary-label">Total IVA:</span>
                    <span class="summary-value">@TotalIVA.ToString("C2", esAr)</span>
                </div>
                <div class="summary-item total-final">
                    <span class="summary-label">Total Final:</span>
                    <span class="summary-value">@TotalFinal.ToString("C2", esAr)</span>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .compact-invoice-summary {
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        padding: 15px;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .summary-section {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px dashed #dee2e6;
    }

        .summary-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

    .section-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        padding-bottom: 4px;
        border-bottom: 1px solid #e9ecef;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 10px;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        font-size: 0.95rem;
    }

    .summary-label {
        color: #495057;
        font-weight: 500;
    }

    .summary-value {
        font-weight: 600;
        color: #212529;
    }

    .discount-control {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .discount-label {
        font-size: 0.95rem;
        color: #495057;
        font-weight: 500;
    }

    .discount-input {
        width: 80px;
        padding: 6px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.95rem;
        text-align: center;
    }

    .discount-percent {
        font-weight: 600;
        color: #495057;
    }

    .highlight {
        background-color: #e8f4ff;
        border-color: #c2e0ff !important;
    }

    .total-final {
        background-color: #e7f5e4 !important;
        border-color: #c3e6bd !important;
        font-weight: 700;
    }

        .total-final .summary-value {
            color: #2e7d32;
            font-size: 1.05rem;
        }

    @@media (max-width: 768px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }

        .discount-control {
            flex-wrap: wrap;
        }
    }
</style>


@code {
    [Parameter] public List<FacturaDetalle> Detalles { get; set; } = new();
    [Parameter] public EventCallback OnGuardar { get; set; }
    [Parameter] public EventCallback OnCancelar { get; set; }

    private decimal DescuentoPorcentaje { get; set; } = 0;

    private readonly CultureInfo esAr = CultureInfo.GetCultureInfo("es-AR");

    // Subtotales (con IVA incluido)
    private decimal SubTotalIva0 => Detalles.Where(d => d.IdTipoIva == 3).Sum(d => d.TotalArticulo ?? 0);
    private decimal SubTotalIva105 => Detalles.Where(d => d.IdTipoIva == 2).Sum(d => d.TotalArticulo ?? 0);
    private decimal SubTotalIva21 => Detalles.Where(d => d.IdTipoIva == 1).Sum(d => d.TotalArticulo ?? 0);
    private decimal SubTotal => SubTotalIva0 + SubTotalIva105 + SubTotalIva21;

    // Subtotales con descuento
    private decimal SubTotalIva0ConDescuento => SubTotalIva0 * (1 - (DescuentoPorcentaje / 100));
    private decimal SubTotalIva105ConDescuento => SubTotalIva105 * (1 - (DescuentoPorcentaje / 100));
    private decimal SubTotalIva21ConDescuento => SubTotalIva21 * (1 - (DescuentoPorcentaje / 100));
    private decimal SubtotalConDescuento => SubTotal * (1 - (DescuentoPorcentaje / 100));

    // IVA discriminado (a partir del precio final)
    private decimal TotalIva0 => 0;
    private decimal TotalIva105 => SubTotalIva105ConDescuento * (10.5m / 110.5m);
    private decimal TotalIva21 => SubTotalIva21ConDescuento * (21m / 121m);
    private decimal TotalIVA => TotalIva105 + TotalIva21;

    //Base imponible
    private decimal BaseImponible21 => SubTotalIva21 / 1.21m;
    private decimal BaseImponible105 => SubTotalIva105 / 1.105m;
    private decimal BaseImponible0 => SubTotalIva0;
    private decimal BaseImponibleTotal => BaseImponible0 + BaseImponible105 + BaseImponible21;


    // Total final
    private decimal TotalFinal => SubtotalConDescuento;

    private async Task OnGuardarClicked()
    {
        if (OnGuardar.HasDelegate)
            await OnGuardar.InvokeAsync();
    }

    private async Task OnCancelarClicked()
    {
        if (OnCancelar.HasDelegate)
            await OnCancelar.InvokeAsync();
    }
}

